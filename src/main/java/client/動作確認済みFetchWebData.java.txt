package client;

import java.sql.SQLException;
import java.time.Duration;
import java.util.ArrayList;
import java.util.List;

import org.openqa.selenium.By;
import org.openqa.selenium.ElementClickInterceptedException;
import org.openqa.selenium.NoSuchElementException;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import io.github.bonigarcia.wdm.WebDriverManager;
import model.AnimeDataModel;
import model.EmotionModel;
import model.ItemRepository;

public class FetchWebData {
	ItemRepository itemRepository;

	public FetchWebData(ItemRepository itemRepository) {
		this.itemRepository = itemRepository;
	}

	public void scrapeAnimeByIdRange() throws InterruptedException {
		final int START_ID = 79;//id78 ã€Œå®‡å®™æµ·è³Šã‚­ãƒ£ãƒ—ãƒ†ãƒ³ãƒãƒ¼ãƒ­ãƒƒã‚¯ï¼ˆTVã‚¢ãƒ‹ãƒ¡å‹•ç”»ï¼‰ã€ã¾ã§å–å¾—å®Œäº†
		final int END_ID = 15114;
		final int MIN_REVIEW_LENGTH = 100;

		try {
			WebDriverManager.chromedriver().setup();
		} catch (Exception e) {
			System.err.println("ãƒ»WebDriverManagerã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å¤±æ•—: " + e.getMessage());
		}

		WebDriver driver = new ChromeDriver();

		try {
			for (int id = START_ID; id <= END_ID; id++) {
				List<AnimeDataModel> resultList = new ArrayList<>();

				String url = "https://www.anikore.jp/anime_review/" + id + "/";
				driver.get(url);
				if(isAdPage(driver)) {
					id--;
					continue;
				}

				String currentUrl = driver.getCurrentUrl();
				if (currentUrl.equals("https://www.anikore.jp/")) {
					System.out.println("ğŸ”¸ ID " + id + " ã¯å­˜åœ¨ã—ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—");
					continue;
				}

				try {
					WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(5));

					// ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
					WebElement titleElement = wait.until(
							ExpectedConditions.presenceOfElementLocated(By.xpath("//*[@id='page-top']/section[4]/div/h1"))
							);
					String title = titleElement.getText().trim();

					// --- ã“ã“ã‹ã‚‰ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’é€£ç¶šã‚¯ãƒªãƒƒã‚¯ã—ã¦å…¨ãƒ¬ãƒ“ãƒ¥ãƒ¼å±•é–‹ ---
					try {
						while (true) {
							WebElement moreButton = driver.findElement(By.cssSelector("button.more_review_button"));
							if (moreButton.isDisplayed() && moreButton.isEnabled()) {
								moreButton.click();
								Thread.sleep(300); // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å¾Œã®èª­ã¿è¾¼ã¿å¾…ã¡
							} else {
								break;
							}
						}
					} catch (NoSuchElementException e) {
						// ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ãŒãªã„å ´åˆã¯ç„¡è¦–ã—ã¦ç¶šè¡Œ
					} catch (ElementClickInterceptedException e) {
						// ã‚¯ãƒªãƒƒã‚¯ã§ããªã‹ã£ãŸå ´åˆã‚‚ãƒ«ãƒ¼ãƒ—çµ‚äº†
					}

					// --- ã€Œãƒã‚¿ãƒãƒ¬æ³¨æ„ã€å±•é–‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦éš ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º ---
					List<WebElement> spoilerButtons = driver.findElements(By.cssSelector(".spoiler_expand_button"));
					for (WebElement btn : spoilerButtons) {
						if (btn.isDisplayed() && btn.isEnabled()) {
							try {
								btn.click();
								//Thread.sleep(500); // ã‚¯ãƒªãƒƒã‚¯å¾Œã®å°‘ã—ã®å¾…æ©Ÿ
							} catch (Exception ignore) {}
						}
					}

					// æ„Ÿæƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—
					List<WebElement> reviewBlocks = driver.findElements(
							By.cssSelector("p.m-reviewUnit_userText_content.ateval_description")
							);

					if (reviewBlocks.isEmpty()) {
						System.out.println("ğŸŸ¡ ID " + id + ": æ„Ÿæƒ³ãªã—ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—");
						continue;
					}

					//å–å¾—ã—ãŸæƒ…å ±ã®å‡¦ç†
					for (WebElement review : reviewBlocks) {
						String impression = review.getText().trim();
						if (isValidReview(impression, MIN_REVIEW_LENGTH)) {
							resultList.add(new AnimeDataModel(title, impression));
						}
					}

					if (resultList.size() == 0) {
						System.out.println("ğŸŸ¡ ID " + id + ": æœ‰åŠ¹ãªæ„Ÿæƒ³ãªã—ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—");
					} else {
						/*for (AnimeDataModel a : resultList) {
							System.out.println(a.getImpression());
							System.out.println("æ„Ÿæƒ³ã“ã“ã¾ã§");
						}*/
						itemRepository.insertTitleAndImpression(resultList);//DBã¸ç™»éŒ²
						System.out.println("âœ… ID " + id + ": " + title + "ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ç™»éŒ²æ•°: " + resultList.size() + "ï¼‰");
					}

				}catch (SQLException e) {
					System.err.println(e);
				}

				//Thread.sleep(1000); // æ¬¡ã®IDå‡¦ç†ã¾ã§1ç§’å¾…æ©Ÿ
			}
		} finally {
			driver.quit();
		}
	}

	public void insertEmotionUsingApi(List<EmotionModel> emotionList) {

	}

	private boolean isValidReview(String text, int minLength) {
		return text.length() >= minLength;
	}

	private boolean isAdPage(WebDriver driver) {
		try {
			String url = driver.getCurrentUrl();

			if (url.contains("#google_vignette") || url.contains("google_vignette") || url.contains("ads")) {
				System.out.println("åºƒå‘Šå‡¦ç†");
				return true;
			}
		} catch (Exception e) {
			return false;
		}
		return false;
	}
}
